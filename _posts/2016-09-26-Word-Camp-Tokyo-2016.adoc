= Word Camp Tokyo 2016 に行ってきた
:hp-alt-title: Word Camp Tokyo 2016
:hp-tags: Wordpress,Conference

徳丸先生

対象

* WordPress
* Joomla!
* Drupal
* Movable Type

事例

NICTへの侵入事件
Joomla! 2.5.1
2012/05

徳丸研究室がやられる
ビルドインされたスーパーユーザー以外を作成
evilさん
Burp Suite で実行（リクエスト途中で止められる）

パラメータの追加
権限を高くする

パスワードを確認用と変える
ログイン失敗後にパスワードを正しく入力した手口？

バリデーションエラー時にセッションに中身を確認せず権限情報を含む情報を入れてしまった

日本テレビへの侵入
Movable Type プラグインが原因

調査報告書
大半は、不適切だが違法ではない
これは、ゼロデイだけど適切なら起きないはずと
以外と手厳しい

パラメータからのOSコマンドインジェクション

遠隔制御でサーバを確認するウェブシェルを設置（やったね）
ウェブシェルは wget や curl などのコマンドで設置できる

Drupageddon

PHP カンファレンス 2015 で紹介済みの内容

ログインブロックにユーザー名とパスワードは適当にして、リクエストを止める。
name を攻撃文字列に変更

えのぽ
Joomla の脆弱性

スクリプト実行

User-Agentに4バイト文字を設定
JoomlaはセッションをDBに格納
MySQLの使用時は4バイト以降は切り捨て
文字列はオブジェクトに化ける PHP

WP本体はそこまで脆弱ではない
WP プラグインは別
WP Mobile Detector に脆弱性
ディレクトリトラバーサルの脆弱性

デモ
/etc/password
脆弱な部分に file_get_content を使用しているのでPHP 標準の設定だとウェブシェルをダウンロード出来るので遊び放題（やったね）

プラグインがアップできない！
プラグインを削除しないといけない。

ランサムウェアの感染経路に悪用されるかも

管理用ツールの認証突破
WPScan(ruby)でクラックしてみる

辞書攻撃でアタックする


技術評論社のサイト改ざん

sakura VPSを使用、フィッシングメールを送りサーバ管理パスワードを乗っ取った
ゲストOSのrootパスワード変更
ゲストOSのイメージ取得（後から秘密情報を取得できる）

管理用コンソールからリブートし、リブート時に設定を変更してシングルユーザーモードでブートできるようにする
パスワードを変更して普通に乗っ取って使用できる

破られる方法結局2通り

* 管理用ツールの人称を突破
* ソフトウェアの脆弱性を悪用

これらが絶対に対応する

単独の脆弱性では問題ないかもしれないが、合わせ技でクリティカルになる事もある

ユーザ名はどうでも良い

パスワードはとにかく複雑に

ソフトウェアのバージョンアップ

* プラグインはむやみに入れない
* CentOS は redhat 社のパッチ作成待ち
* Ver UP でサイトが動かなくなるなんて心配をしないでとにかく Ver UP
* イメージのバックアップは取っておこう

WPなら SiteGuard WP Pluginを入れよう

FireWall(WAF)を設定する

根本的解決策と保険的対策

保険的対策（ゼロデイ向け）

* PHPの機能制限
* パーミッション設定
* IPアドレス制限

WP の CDN 化 高速化とセキュリティ

WP の CDN 化
従来
イメージのみのCDN化

HTMLファイルのCDN化は不十分

CDNとは
貧弱なオリジンサーバの代わりに世界に分散して配信できる

* ピーク対策
* 遠距離対策
* DDoS対策
** 通常のCDNはレイヤ3以下の物量攻撃には強いが、レイヤ4(TCP)以上の攻撃には弱い

CDNのトラブルシュート

* CDNが外れる
** オリジンサイトのFQDNが含まれる（リンクとHTTPヘッダ）
* 動作がおかしい
** CDNがURLパラメータを削除
** CDNがCookieを削除する
* キャッシュされない
** オリジンサイトのCMSがno-cacheを付けている
* キャッシュが古い
** ファイルにno-cacheなどを付けていない

通常だと、WPはすべて該当

WPのCDN化

* イメージだけ（レベル1）
** 設定はプラグインのみで容易、セキュリティ対策とHTML生成負荷対策は全く出来ない
** 画像をCDNサーバ経由で読みに行く
* サイト全体のCDN化（レベル2、3）
** wp-adminがオリジンの場合はレベル3
** セキュリティ対策とHTML生成負荷対策が可能

* オリジン設定変更（レベル2は必要ない）
* CDN設定（レベル2は必要 HTTP HOST ヘッダの指定が必要）
* DNS設定変更（レベル2は必要）

レベル3のメリット
* CDN経由でのアクセスをカットできる
* CDNが落ちても問題ない

https://tech.jstream.jp/blog/meeting/wordcamptokyo2016/

RestAPIとjQueryで作る最短アプリ開発

JavaScript祭

WP OAuth Server 
年間約5000円（ドル建て）
OAuth 2.0 認証

感想：
主要CMSでREST APIが提供されているので、

WPでも意識したいアクセシビリティ

誰のため？
全員が常に万全ではないので、その時のため
https://news.nifty.com/article/domestic/government/12152-199202/

accessibility_ready タグ付きテーマのみ（要レビュー）

WPはコア周りは WCAG 2.0 レベルAA 準拠
WCAG W3Cが策定
JIS X 8341-3:2016 WCAGに互換性あり

WPでのアクセシビリティ

* 見出しを正しく付ける
** 先頭で内容を識別できるように
* 画像で気をつけるポイント
** 画像の alt は付けよう、ヘッダ画像などは、alt="" で対応
** 画像追加時のデフォルト挙動があまり良くない
** figure 要素に特定属性の設定で画像の alt を飛ばせる
* 動画（収録済み）で気をつけるポイント
** キャプションを提供（字幕ではなくト書きも追加）
** 動画プレイヤーはキーボード操作可能が望ましい（Youtube や WP のプレイヤーは対応）
* ループアニメーションgif
** ループを5秒で止める
* リンクで気をつける
** リンク先の内容を分かるようにする
* 


WP のアクセシビリティは1人では出来ない


WPの高速化

一般的には、表示速度は重視されていない

基準
表示開始：0.5秒

表示完了：2秒以内
DOM Complete

エラー率
3%

日本のEコマースサイトのパフォーマンス
ビックカメラよりは米国の主要サイトは早い事が多い

日本人も遅いサイトは 47% が二度と来ない

2秒以内に表示させるようにすると直帰率の改善が目に見える

民法改正
瑕疵担保責任の変更
品質も瑕疵担保責任の範疇になった

Best Practice から Proven Practiceへ
Best Practice : Google Speed


事象の例：画像が重い

ベストプラクティスだと、画像を小さくする

WindowsのNTFSが原因
NFSでNASをマウントして使っていた

Webの配信サービスは複雑系

ブラウザのパフォーマンスツールは？
カバー率（経路、通信回線）の問題
カバー率（時間、アクセス時間帯）の問題

速さをどれぐらい保証できるかが品質の高低に繋がる

パフォーマンスは一意に定まらない
平均は見ていけない。（最大値や最小値、最頻値が分からなくなってしまう）

パフォーマンスの悪さを決定する箇所
ウィーケストリンク

WPならネットワーク側

携帯網は帯域が指定されているので、自ずと配信できる量は決定されてしまう

1ページ辺り200KBを越えたら、LTEでは3秒では配信できない

WPの比較
カスタマイズ済みと素でも100msしか違いが無い

WPは高速化できるが、ネットワークは早くできない。
光遅いとか

高速化のパラダイムシフト
許容できるのは何かを考える

サードパーティー
中国向けはGoogle禁止（30秒遅延）